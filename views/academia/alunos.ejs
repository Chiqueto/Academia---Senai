<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles/output.css" />
    <title>Lista de Alunos</title>
  </head>
  <body class="flex flex-col min-h-screen bg-gray-900">
    <header>
      <nav class="flex justify-between bg-zinc-800 py-5 px-4">
        <div class="flex items-center gap-4">
          <a href="/academia/menu/<%= id %>">
            <img src="/icons/back_arrow.svg" alt="Voltar" />
          </a>
          <h1 class="font-jaro text-zinc-50 text-3xl">GymFit</h1>
        </div>
      </nav>
    </header>
    <main class="mx-4 flex-grow">
      <section class="font-zain px-4">
        <h2 class="text-3xl text-center text-white py-4">Lista de Alunos</h2>
        <!-- Barra de pesquisa -->
        <div class="relative w-full mb-6">
          <input
            type="text"
            id="search-bar"
            placeholder="Pesquisar por nome ou ID..."
            oninput="buscarAlunos()"
            class="w-full py-3 pl-10 pr-4 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-pink-500"
          />
          <div
            class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"
          >
            <img src="/icons/lupa.svg" class="w-5 h-5" />
          </div>
        </div>
        <!-- Lista de alunos -->
        <div class="alunos space-y-2" id="listaAlunos">
          <% if (alunos && alunos.length > 0) { %> <% alunos.forEach(aluno => {
          %>
          <div
            class="flex justify-between items-center bg-white rounded-lg p-4 shadow-md"
          >
            <span class="text-2xl text-gray-800 font-semibold"
              ><%= aluno.nome %></span
            >
            <span class="text-xl text-gray-600">ID: <%= aluno.id %></span>
          </div>
          <% }) %> <% } else { %>
          <p class="text-gray-300">Nenhum aluno encontrado.</p>
          <% } %>
        </div>
      </section>
      <form id="adicionarAluno" class="mt-6 flex items-center gap-4">
        <label for="aluno.id" class="text-lg font-medium text-gray-800">
          ID do Aluno:
        </label>
        <input
          type="text"
          id="aluno.id"
          name="aluno.id"
          required
          class="py-2 px-4 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-pink-500"
        />
        <button
          type="submit"
          class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition duration-300"
        >
          Adicionar Aluno
        </button>
      </form>
    </main>
    <script>
      async function adicionarAluno() {
        const idAluno = document.getElementById("aluno.id").value.trim();
        const idAcademia = "<%= id %>"; // ID da academia vindo do EJS
        if (!idAluno) {
          alert("Por favor, insira o ID do aluno.");
          return;
        }

        console.log("Iniciando requisição para adicionar aluno...");

        try {
          const response = await fetch(
            `/academia/adicionarAluno/${idAcademia}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ idAluno }),
            }
          );

          console.log("Resposta recebida:", response);

          const result = await response.json();
          if (response.ok) {
            alert("Aluno adicionado com sucesso!");
            atualizarListaAlunos(); // Atualiza a lista de alunos após adicionar
          } else {
            alert(result.error || "Erro ao adicionar aluno.");
          }
        } catch (error) {
          console.error("Erro ao adicionar aluno:", error);
        }
      }

      async function atualizarListaAlunos() {
        const idAluno = document.getElementById("aluno.id").value.trim();
        const idAcademia = "<%= id %>";
        console.log("Atualizando lista de alunos para a academia:", idAcademia);

        try {
          const response = await fetch(`/academia/findStudents/${idAcademia}`);
          const alunos = await response.json();
          console.log("Lista de alunos recebida:", alunos);
          const listaAlunos = document.getElementById("listaAlunos");

          listaAlunos.innerHTML = "";

          if (alunos.length > 0) {
            alunos.forEach((aluno) => {
              const div = document.createElement("div");
              div.classList.add(
                "flex",
                "justify-between",
                "items-center",
                "bg-white",
                "rounded-lg",
                "p-4",
                "shadow-md"
              );
              div.innerHTML = `
                <span class="text-2xl text-gray-800 font-semibold">${aluno.nome}</span>
                <span class="text-xl text-gray-600">ID: ${aluno.id}</span>
              `;
              listaAlunos.appendChild(div);
            });
          } else {
            listaAlunos.innerHTML =
              '<p class="text-gray-300">Nenhum aluno encontrado.</p>';
          }
        } catch (error) {
          console.error("Erro ao atualizar lista de alunos:", error);
        }
      }
      document
        .getElementById("adicionarAluno")
        .addEventListener("submit", async (e) => {
          e.preventDefault(); // Evita o comportamento padrão do formulário
          adicionarAluno();
          const idAluno = document.getElementById("aluno.id").value.trim();
          const idAcademia = "<%= id %>"; // ID da academia vindo do EJS
        });
    </script>
  </body>
</html>
